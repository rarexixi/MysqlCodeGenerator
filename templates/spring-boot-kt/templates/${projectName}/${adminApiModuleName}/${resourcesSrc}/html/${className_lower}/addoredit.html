<#include "/include/table/properties.ftl">
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>${tableComment}管理</title>
    <link rel="stylesheet" href="//unpkg.com/element-ui/lib/theme-chalk/index.css">
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/element-ui-override.css">
</head>
<body>
<div id="app">
    <el-breadcrumb separator="/">
        <el-breadcrumb-item>${tableComment}管理</el-breadcrumb-item>
        <el-breadcrumb-item>${tableComment}列表</el-breadcrumb-item>
        <el-breadcrumb-item>{{addOrEditTitle}}</el-breadcrumb-item>
    </el-breadcrumb>
    <div>
        <el-form ref="addOrEditParams" :model="addOrEditParams" label-position="left" label-width="120px" size="small">
            <#list table.columns as column>
            <#include "/include/column/properties.ftl">
            <#if column.notRequired>
            <#elseif column.autoIncrement>
            <#elseif (column.select)>
            <el-form-item label="${columnComment}">
                <el-select v-model="addOrEditParams.${fieldName}" placeholder="请选择">
                    <el-option v-for="item in ${fieldNameExceptKey}SelectList" :value="item.value" :label="item.text"></el-option>
                </el-select>
            </el-form-item>
            <#elseif (column.fkSelect)>
            <el-form-item label="${columnComment}">
                <el-select v-model="addOrEditParams.${fieldName}" filterable placeholder="请选择">
                    <el-option v-for="item in ${fieldNameExceptKey}SelectList" :value="item.${column.fkSelectColumn.valueName?uncap_first}" :label="item.${column.fkSelectColumn.textName?uncap_first}"></el-option>
                </el-select>
            </el-form-item>
            <#elseif (column.validStatus)>
            <#-- <el-form-item label="${columnComment}">
                <el-select v-model="addOrEditParams.${fieldName}" placeholder="请选择">
                    <el-option v-for="item in ${fieldName}SelectList" :value="item.value" :label="item.text"></el-option>
                </el-select>
            </el-form-item> -->
            <#elseif (isInteger)>
            <el-form-item label="${columnComment}">
                <el-input v-model="addOrEditParams.${fieldName}"></el-input>
            </el-form-item>
            <#elseif (isDecimal)>
            <el-form-item label="${columnComment}">
                <el-input v-model="addOrEditParams.${fieldName}"></el-input>
            </el-form-item>
            <#elseif (isDate)>
            <el-form-item label="${columnComment}">
                <el-date-picker v-model="addOrEditParams.${fieldName}" type="date" placeholder="选择日期"></el-date-picker>
            </el-form-item>
            <#elseif (isTime)>
            <el-form-item label="${columnComment}">
                <el-time-select v-model="addOrEditParams.${fieldName}" placeholder="选择时间"></el-time-select>
            </el-form-item>
            <#elseif (isDateTime)>
            <el-form-item label="${columnComment}">
                <el-date-picker v-model="addOrEditParams.${fieldName}" type="datetime" placeholder="选择日期时间"></el-date-picker>
            </el-form-item>
            <#elseif (isContent)>
            <el-form-item label="${columnComment}">
                <el-input v-model="addOrEditParams.${fieldName}" type="textarea" :autosize="{ minRows: 5, maxRows: 100}"></el-input>
            </el-form-item>
            <#elseif (isString)>
            <el-form-item label="${columnComment}">
                <el-input v-model="addOrEditParams.${fieldName}" type="text"></el-input>
            </el-form-item>
            <#else>
            </#if>
            </#list>
        </el-form>
        <div class="dialog-footer">
            <el-button @click="back" icon="el-icon-arrow-left" size="small">返回列表</el-button>
            <el-button @click="save" type="primary" icon="el-icon-document" size="small">保存</el-button>
        </div>
    </div>
</div>

<script src="//unpkg.com/vue/dist/vue.js"></script>
<script src="//unpkg.com/element-ui/lib/index.js"></script>
<script src="//unpkg.com/axios/dist/axios.min.js"></script>
<script src="/js/config.js"></script>
<script src="/js/common.js"></script>
<script>
    <#include "/include/table/properties.ftl">
    <#macro mapperEl value>${r"${"}${value}}</#macro>
    let app = new Vue({
        el: '#app',
        data: {
            <#include "/include/js/data_select_list.ftl">
            <#list table.fkSelectColumns as column>
            <#include "/include/column/properties.ftl">
            ${fieldNameExceptKey}SelectList: [],
            </#list>
            pkParams: {
                <#list pks as column>
                <#include "/include/column/properties.ftl">
                ${fieldName}: ''<#if column?has_next>,</#if>
                </#list>
            },
            addOrEditParams: {
                <#list table.requiredColumns as column>
                <#include "/include/column/properties.ftl">
                <#if (column.validStatus)>
                <#-- ${fieldName}: ${table.validStatusColumn.validStatusOption.valid}<#if column?has_next>,</#if> -->
                <#else>
                ${fieldName}: ''<#if column?has_next>,</#if>
                </#if>
                </#list>
            },
            addOrEditTitle: '',
            copy: false
        },
        mounted: function () {
            let self = this;
            <#list table.fkSelectColumns as column>
            <#include "/include/column/properties.ftl">
            self.init${propertyExceptKey}();
            </#list>
            self.copy = commonFun.getParam('copy') == 'true';
            <#list table.pks as column>
            <#include "/include/column/properties.ftl">
            self.pkParams.${fieldName} = commonFun.getParam('${fieldName}');
            </#list>
            if (<#list pks as column><#include "/include/column/properties.ftl"><#if (column_index > 0)> && </#if>self.pkParams.${fieldName} == ''</#list>) {
                self.addOrEditTitle = '添加${tableComment}';
            } else {
                self.addOrEditTitle = self.copy ? '添加${tableComment}' : '更新${tableComment}';
                self.get();
            }
            document.title = self.addOrEditTitle;
        },
        methods: {
            save: function () {
                let self = this;
                let ajaxUrl;
                if (self.copy || (<#list pks as column><#include "/include/column/properties.ftl"><#if (column_index > 0)> && </#if>self.pkParams.${fieldName} == ''</#list>)) {
                    ajaxUrl = '/${tablePath}/add';
                } else {
                    <#if table.hasAutoIncUniPk>
                    ajaxUrl = '/${tablePath}/update';
                    <#else>
                    ajaxUrl = '/${tablePath}/update?'<#list pks as column><#include "/include/column/properties.ftl"><#if (column_index > 0)> + '&'</#if> + '${fieldName}=' + self.pkParams.${fieldName}</#list>;
                    </#if>
                }

                self.ajaxPost(ajaxUrl, self.addOrEditParams, '操作失败！', response => {
                    self.$notify({
                        message: '操作成功！',
                        type: 'success'
                    });
                });
            },
            get: function (copy) {
                let self = this;

                let url = '/${tablePath}/detail';
                let params = self.pkParams;
                self.ajaxGet(url, params, '获取详情失败！', response => {
                    <#list table.columns as column>
                    <#include "/include/column/properties.ftl">
                    <#if column.notRequired>
                    <#elseif column.autoIncrement>
                    if (!self.copy) {
                        self.addOrEditParams.${fieldName} = response.result.${fieldName};
                    }
                    <#else>
                    self.addOrEditParams.${fieldName} = response.result.${fieldName};
                    </#if>
                    </#list>
                });
            },
            <#list table.fkSelectColumns as column>
            <#include "/include/column/properties.ftl">
            init${propertyExceptKey}: function () {
                let self = this;
                let url = '/${column.fkSelectColumn.foreignTargetTableName?replace("_", "-")}/list';
                let params = {
                    condition: {
                        <#list column.fkSelectColumn.conditions as condition>
                        ${condition.field}: '${condition.value}'<#if condition?has_next>,</#if>
                        </#list>
                    },
                    order: {}
                };
                self.ajaxPost(url, params, '获取${columnComment}列表失败！', response => {
                    self.${fieldNameExceptKey}SelectList = response.result;
                });
            },
            </#list>
            back: function () {
                let self = this;
                location.href = 'list.html';
            }
        }
    });

</script>
</body>
</html>
